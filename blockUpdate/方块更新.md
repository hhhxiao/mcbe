

# 方块更新

> 基于1.14.2的服务端进行的分析

## 区块间更新

世界的更新是以区块为单位的，当模拟距离为`4`的时候每`gt`有`57`个区块发生了更新(57个是绝大多数情况下)，更新的区块围绕在玩家周围，下图是某个`gt`的区块更新：

![pic](..\pic\c2.png)

玩家位于绿框区块中，数字大小展示了这一`gt`区块更新的顺序.很不幸的是这个**区块间更新的顺序**没有什么很好的规律，它每过`17-20gt`会更新一次且每次的顺序毫无规律，更为奇怪的是每次更新区块间的更新顺序的时候都会有一次不均匀的区块更新，也就是说**某些区块会获得两次更新，而某些区块不会得到更新，**，下面是一个这样的例子:



![2](..\pic\c1.png)

## 区块内的更新

以下描述的都是1个区块一个`gt`内依次发生的事情(忽略`Spawn`和`despawn`):

1. 随机刻更新
2. 更新队列更新 
3. 更新队列更新 
4. 方块实体更新
5. 红石更新

> 更新队列更新是调用方块的`tick()`函数，红石更新是调用的`redstoneUpdate()`函数

### 随机刻更新

这个事件里面的更新都是基于概率的，因此才有"随机"二字

其内部会发生如下事情：

1. 尝试改变天气
2. 如果在下雨或者打雷就尝试生成闪电来劈实体，然后尝试生成骷髅马陷阱
3. 进行一次结冰尝试
4. 进行一次给地表铺上雪片的尝试
5. 根据当前随机刻计算更新次数，选择一些方块进行随机刻更新，当然选择的方块要合适，比如树苗，作物的成长等等


### 更新队列更新

每个区块都存了一个**优先队列**，这个队列里面有将要进行的方块更新列表

在这个更新内部:

1. 获取更新队列的长度
2. 从队列中获取前`100`个方块更新的数据项(不足100就全部获取)然后放置到另外一个缓冲队列中(如果更新位置在加载区块之外该更新就无效但是还是算这100个之内)
3. 每个更新数据项都记录了该更新的方块类型，状态，坐标以及更新时间戳
4. 对缓冲队列里面的更新数据项依次执行其对应的`tick()`函数，每次优先更新时间戳小的更新项（当然不排除针对某些更新的**特意的随机行为**）


> 当退出游戏的时候每个区块的更新队列会被完整地写入到存档文件，加载世界的时候也会被完整读取出来
>
> **可能导致更新队列越来越长的情况**

### 更新队列的更新数据项的来源：

更新队列中的更新数据项来自于玩家和世界的交互以及随机刻更新产生的方块更新

可暂时分为以下两类

1. `neighborChanged`更新
2. 其他

#### `neighborChanged`更新

`neighborChanged`更新就是某个位置的方块被更新后会发出一个`neighborChanged`更新，这个更新会被发往和它临近的六个方块，发送的顺序为：

1. -x 西
2. +x 东
3. +z 南
4. -z 北
5. +y 上
6. -y 下

收到`neighborChanged`更新的方块会执行它们的``neighborChanged`函数，比如沙子会判定是否开始下落等，当然收到更新后也可能产生新的`neighborChanged`更新并发送给其邻近的6个方块

具有实际行为的`neighborChanged`更新的方块有:

- `ActorBlock`(漏斗,熔炉，附魔台，箱子等等)
- 竹方块
- 竹树苗方块
- 旗帜方块
- 压力板方块
- 铁路方块
- 床方块
- 钟方块
- 气泡柱方块
- 灌木丛方块
- 按钮方块
- 仙人掌方块
- 蛋糕方块
- 营火方块
- 炼药锅方块
- 紫颂花方块
- 紫颂植物方块
- 可可豆方块
- 命令方块
- 比较器方块
- 混凝土方块
- 珊瑚(扇)方块
- 作物方块
- 中继器方块
- 泥土方块
- 耕地方块
- 栅栏方块
- 火方块
- 花盆方块
- 冰块
- 草方块
- 草径方块
- 磨石机方块
- 重力方块(沙子沙砾等)
- 物品展示框方块
- 海草方块
- 梯子方块
- 灯笼方块
- 拉杆方块
- 流体方块
- 岩浆块
- 观察者方块
- 活塞臂方块
- 活塞方块
- 灰化土方块
- 传送门方块
- 红石线方块
- 红石火把方块
- 甘蔗方块
- 沙子方块
- 脚手架方块
- 海带方块
- 海泡菜方块
- 标志牌方块
- 灵魂沙方块
- 海绵方块
- 火把方块
- 绊线钩方块
- 藤蔓方块
- 羊毛毯方块

绝大多数的能响应`neighborChanged`都是需要依附其他方块才能存在的方块,**有些方块在收到该更新的时候直接完成更新行为，有些方块先进行一些准备工作,实际的更新行为留给方块队列更新**

而常见的能产生的`neighborChanged`更新有：

- 方块被破坏和放置
- 需要附着方块的方块它的附着方块消失而使得自己成为掉落物
- 铁轨被激活
- 拉杆被拉动

等等

#### 其他

有些更新被传递给别的方块的时候不会触发``neighborChanged`函数，而是进行其它操作,比如:

- 混凝土粉末凝固(能被观察者检测但是不触发`neighborChanged`)
- 栅栏等连接方块的状态被改变

等等

更多行为以及细节待补充



### 红石更新

`tickRedstone()`每`gt`每个被加载的区块都会执行一次

#### 要更新的方块从哪来

部分方块在被放置到世界后会被加入到一个哈希表中，(不出意外的话)更新的就是这里面的所有方块，由于哈希表这一数据结构的特殊性,**每次的更新顺序取仅和坐标有关而且每次的顺序都是不固定的**

所有方块都有`onRedstoneUpdate`函数,只不过默认都是没有行为的,下面这些特定方块才回有具体的事件:

- 激活铁轨更新
- 普通铁轨更新
- 充能铁轨更新
- 命令方块
- 比较器更新输出
- 中继器
- 发射器更新
- 门开关
- 栅栏门打开
- 漏斗方块设置有无被锁
- 音符盒放声音
- 红石线更新
- 红石灯点亮
- 红石火把更新能量等级？
- TNT爆炸
- 陷阱门打开
- 结构方块充能

这类更新会在当前`gt`内完成更新**更新的同时有可能产生更新队列更新，而这些更新只能等到下一个`gt`才可能被执行**





### 方块实体更新

每个区块都维护了一个方块实体列表,**每`gt`这个列表都会被随机打乱一次**,然后遍历这个列表，执行`tick()`函数,括号内是猜测的行为(不能保证100%准确)

所有的方块实体更新:

- 生物头颅(龙头响应红石信号)
- 潜影盒(更新碰撞箱和普通箱子更新)
- 活塞(响应红石信号以及其它行为)
- 移动中的方块
- 刷怪笼
- 唱片机(放声音等)
- 展示框(处理内部一些特殊的方块更新如指南针)
- 漏斗（漏物品）
- 熔炉（烧物品）
- 折跃门
- 附魔台(更新随机附魔相关？)
- 阳光侦测器（根据时间更新状态）
- 潮涌核心(给buff)
- 比较器(更新？)
- 陷阱箱
- 化学方块？
- 炼药锅
- 营火（更新粒子效果等等）
- 酿造台（炼药）
- 钟（发出声音）
- 蜂巢
- 床
- 信标（给buff）
- 旗帜











